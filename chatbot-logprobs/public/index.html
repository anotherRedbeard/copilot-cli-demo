<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Context Demo â€” Log Probs</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', -apple-system, sans-serif;
    background: #0d1117;
    color: #e6edf3;
    height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 800px;
    margin: 0 auto;
  }

  header {
    padding: 16px 24px;
    border-bottom: 1px solid #30363d;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  header h1 {
    font-size: 1.1em;
    font-weight: 700;
    background: linear-gradient(135deg, #3fb950, #58a6ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  header .badge {
    font-size: 0.65em;
    background: #161b22;
    border: 1px solid #30363d;
    padding: 3px 8px;
    border-radius: 12px;
    color: #8b949e;
  }

  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.6;
    font-size: 0.95em;
  }
  .msg.user {
    align-self: flex-end;
    background: #1f6feb;
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .msg.assistant {
    align-self: flex-start;
    background: #161b22;
    border: 1px solid #30363d;
    border-bottom-left-radius: 4px;
  }

  .token {
    display: inline;
    cursor: pointer;
    position: relative;
    border-radius: 3px;
    padding: 1px 0;
    transition: background 0.15s;
  }
  .token:hover {
    background: rgba(255,255,255,0.1);
  }

  .tooltip {
    display: none;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    background: #1c2128;
    border: 1px solid #444c56;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.75em;
    white-space: nowrap;
    z-index: 100;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    line-height: 1.6;
  }
  .tooltip.above { bottom: calc(100% + 8px); top: auto; }
  .tooltip.below { top: calc(100% + 8px); bottom: auto; }
  .token:hover .tooltip { display: block; }
  .tooltip .alt { color: #8b949e; }
  .tooltip .alt-token { color: #e6edf3; }
  .tooltip .alt-prob { float: right; margin-left: 16px; }

  .input-area {
    padding: 16px 24px;
    border-top: 1px solid #30363d;
    display: flex;
    gap: 10px;
  }
  .input-area textarea {
    flex: 1;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 10px;
    color: #e6edf3;
    padding: 12px 16px;
    font-size: 0.95em;
    font-family: inherit;
    resize: none;
    outline: none;
    height: 48px;
    max-height: 150px;
    overflow-y: hidden;
  }
  .input-area textarea:focus { border-color: #58a6ff; }
  .input-area textarea::placeholder { color: #484f58; }

  .input-area button {
    background: #238636;
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 0 20px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.9em;
  }
  .input-area button:hover { background: #2ea043; }
  .input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

  .loading {
    align-self: flex-start;
    color: #8b949e;
    font-style: italic;
    font-size: 0.85em;
    padding: 8px 0;
  }
  .loading::after {
    content: '';
    animation: dots 1.2s steps(4, end) infinite;
  }
  @keyframes dots {
    0% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
  }

  .clear-btn {
    background: none;
    border: 1px solid #30363d;
    color: #8b949e;
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 0.7em;
    margin-left: auto;
  }
  .clear-btn:hover { border-color: #8b949e; color: #e6edf3; }
</style>
</head>
<body>

<header>
  <h1>ðŸ¦œ Context Demo</h1>
  <span class="badge">Log Probs Visualizer</span>
  <button class="clear-btn" onclick="clearChat()">Clear Chat</button>
</header>

<div class="chat-area" id="chat"></div>

<div class="input-area">
  <textarea id="input" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send();}"></textarea>
  <button id="sendBtn" onclick="send()">Send</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');

let conversationHistory = [];

function probToColor(logprob) {
  const prob = Math.exp(logprob);
  if (prob >= 0.85) return '#3fb950';   // green â€” very confident
  if (prob >= 0.60) return '#58a6ff';   // blue
  if (prob >= 0.35) return '#f0883e';   // orange
  return '#f85149';                      // red â€” uncertain
}

function probToPercent(logprob) {
  return (Math.exp(logprob) * 100).toFixed(1);
}

function renderTokens(logprobsContent) {
  return logprobsContent.map(item => {
    const color = probToColor(item.logprob);
    const pct = probToPercent(item.logprob);

    let tooltipHTML = `<strong style="color:${color};">"${escapeHtml(item.token)}"</strong> â€” ${pct}%<br>`;
    if (item.top_logprobs && item.top_logprobs.length > 0) {
      tooltipHTML += '<hr style="border-color:#30363d;margin:4px 0;">';
      tooltipHTML += '<span class="alt">Alternatives:</span><br>';
      item.top_logprobs.forEach(alt => {
        const altPct = probToPercent(alt.logprob);
        tooltipHTML += `<span class="alt-token">"${escapeHtml(alt.token)}"</span><span class="alt-prob" style="color:${probToColor(alt.logprob)};">${altPct}%</span><br>`;
      });
    }

    const displayToken = item.token.replace(/\n/g, '<br>');
    return `<span class="token" style="color:${color};"><span class="tooltip">${tooltipHTML}</span>${displayToken}</span>`;
  }).join('');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function send() {
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = '48px';
  input.style.overflowY = 'hidden';
  sendBtn.disabled = true;

  addMessage('user', escapeHtml(text));
  conversationHistory.push({ role: 'user', content: text });

  const loading = document.createElement('div');
  loading.className = 'loading';
  loading.textContent = 'Thinking';
  chat.appendChild(loading);
  chat.scrollTop = chat.scrollHeight;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: conversationHistory })
    });

    loading.remove();

    if (!res.ok) {
      const err = await res.text();
      addMessage('assistant', `<span style="color:#f85149;">Error: ${escapeHtml(err)}</span>`);
      sendBtn.disabled = false;
      return;
    }

    const data = await res.json();
    const choice = data.choices[0];
    const content = choice.message.content;

    conversationHistory.push({ role: 'assistant', content });

    if (choice.logprobs && choice.logprobs.content) {
      addMessage('assistant', renderTokens(choice.logprobs.content));
    } else {
      addMessage('assistant', escapeHtml(content));
    }
  } catch (e) {
    loading.remove();
    addMessage('assistant', `<span style="color:#f85149;">Connection error: ${escapeHtml(e.message)}</span>`);
  }

  sendBtn.disabled = false;
  input.focus();
}

function clearChat() {
  conversationHistory = [];
  chat.innerHTML = '';
  input.style.height = '48px';
  input.style.overflowY = 'hidden';
  input.focus();
}

// Auto-expand textarea as user types
input.addEventListener('input', function() {
  this.style.height = '48px';
  if (this.scrollHeight > 48) {
    const h = Math.min(this.scrollHeight, 150);
    this.style.height = h + 'px';
    this.style.overflowY = h >= 150 ? 'auto' : 'hidden';
  }
});

// Position tooltip above or below based on available space
document.addEventListener('mouseenter', function(e) {
  const token = e.target.closest('.token');
  if (!token) return;
  const tooltip = token.querySelector('.tooltip');
  if (!tooltip) return;

  // Briefly show to measure
  tooltip.classList.remove('above', 'below');
  tooltip.classList.add('above');

  const tokenRect = token.getBoundingClientRect();
  // If token is in the top 120px of viewport, show tooltip below
  if (tokenRect.top < 200) {
    tooltip.classList.remove('above');
    tooltip.classList.add('below');
  }
}, true);

input.focus();
</script>
</body>
</html>
